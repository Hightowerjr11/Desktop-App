cmake_minimum_required(VERSION 3.5)

set(CMAKE_INCLUDE_CURRENT_DIR ON)

set(CMAKE_AUTOUIC ON)
set(CMAKE_AUTOMOC ON)
set(CMAKE_AUTORCC ON)

set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)

find_package(QT NAMES Qt6 Qt5 REQUIRED COMPONENTS Widgets Network Core5Compat)
find_package(Qt${QT_VERSION_MAJOR} REQUIRED COMPONENTS Widgets Network Core5Compat)

set(PROJECT_SOURCES
    engine/apiinfo/apiinfo.cpp
    engine/apiinfo/checkupdate.cpp
    engine/apiinfo/sessionstatus.cpp
    engine/apiinfo/location.cpp
    engine/apiinfo/group.cpp
    engine/apiinfo/node.cpp
    engine/apiinfo/notification.cpp
    engine/apiinfo/portmap.cpp
    engine/apiinfo/staticips.cpp
    engine/apiinfo/servercredentials.cpp
    engine/autoupdater/downloadhelper.cpp
    engine/ping/keepalivemanager.cpp
    engine/locationsmodel/enginelocationsmodel.cpp
    engine/locationsmodel/apilocationsmodel.cpp
    engine/locationsmodel/customconfiglocationsmodel.cpp
    engine/locationsmodel/locationitem.cpp
    engine/locationsmodel/pingipscontroller.cpp
    engine/locationsmodel/pingstorage.cpp
    engine/locationsmodel/bestlocation.cpp
    engine/locationsmodel/baselocationinfo.cpp
    engine/locationsmodel/mutablelocationinfo.cpp
    engine/locationsmodel/customconfiglocationinfo.cpp
    engine/locationsmodel/pinglog.cpp
    engine/locationsmodel/failedpinglogcontroller.cpp
    engine/locationsmodel/nodeselectionalgorithm.cpp
    engine/packetsizecontroller.cpp
    engine/enginesettings.cpp
    engine/tempscripts_mac.cpp
    engine/logincontroller/logincontroller.cpp
    engine/logincontroller/getallconfigscontroller.cpp
    engine/proxy/proxysettings.cpp
    engine/types/connectionsettings.cpp
    engine/getmyipcontroller.cpp
    engine/firewall/uniqueiplist.cpp
    engine/firewall/firewallexceptions.cpp
    engine/firewall/firewallcontroller.cpp
    engine/proxy/proxyservercontroller.cpp
    engine/types/dnsresolutionsettings.cpp
    engine/connectionmanager/makeovpnfile.cpp
    engine/connectionmanager/adaptergatewayinfo.cpp
    engine/connectionmanager/stunnelmanager.cpp
    engine/connectionmanager/testvpntunnel.cpp
    engine/connectionmanager/openvpnconnection.cpp
    engine/connectionmanager/connsettingspolicy/autoconnsettingspolicy.cpp
    engine/connectionmanager/connsettingspolicy/manualconnsettingspolicy.cpp
    engine/connectionmanager/connsettingspolicy/customconfigconnsettingspolicy.cpp
    engine/connectionmanager/connectionmanager.cpp
    engine/connectionmanager/availableport.cpp
    engine/macaddresscontroller/imacaddresscontroller.cpp
    engine/logincontroller/getapiaccessips.cpp
    engine/helper/initializehelper.cpp
    engine/refetchservercredentialshelper.cpp
    engine/vpnshare/httpproxyserver/httpproxyserver.cpp
    engine/vpnshare/httpproxyserver/httpproxyconnectionmanager.cpp
    engine/vpnshare/httpproxyserver/httpproxyconnection.cpp
    engine/vpnshare/httpproxyserver/httpproxyrequestparser.cpp
    engine/vpnshare/httpproxyserver/httpproxyrequest.cpp
    engine/vpnshare/httpproxyserver/httpproxywebanswer.cpp
    engine/vpnshare/httpproxyserver/httpproxywebanswerparser.cpp
    engine/vpnshare/socksproxyserver/socksproxyserver.cpp
    engine/vpnshare/socksproxyserver/socksproxyconnectionmanager.cpp
    engine/vpnshare/socksproxyserver/socksproxyconnection.cpp
    engine/vpnshare/socksproxyserver/socksproxyreadexactly.cpp
    engine/vpnshare/socksproxyserver/socksproxyidentreqparser.cpp
    engine/vpnshare/socketutils/socketwriteall.cpp
    engine/vpnshare/socksproxyserver/socksproxycommandparser.cpp
    engine/vpnshare/vpnsharecontroller.cpp
    engine/vpnshare/connecteduserscounter.cpp
    engine/vpnshare/httpproxyserver/httpproxyreply.cpp
    engine/connectstatecontroller/connectstatecontroller.cpp
    engine/openvpnversioncontroller.cpp
    engine/types/types.cpp
    engine/serverapi/curlnetworkmanager.cpp
    engine/serverapi/curlrequest.cpp
    engine/serverapi/dnscache.cpp
    engine/serverapi/serverapi.cpp
    engine/engine.cpp
    engine/crossplatformobjectfactory.cpp
    engine/types/loginsettings.cpp
    engine/emergencycontroller/emergencycontroller.cpp
    engine/dnsresolver/areslibraryinit.cpp
    engine/dnsresolver/dnsrequest.cpp
    engine/dnsresolver/dnsserversconfiguration.cpp
    engine/dnsresolver/dnsresolver.cpp
    engine/types/protocoltype.cpp
    engine/tests/sessionandlocations_test.cpp
    engine/sessionstatustimer.cpp
    engine/connectionmanager/wstunnelmanager.cpp
    engine/customconfigs/customconfigs.cpp
    engine/customconfigs/customconfigtype.cpp
    engine/customconfigs/ovpncustomconfig.cpp
    engine/customconfigs/wireguardcustomconfig.cpp
    engine/connectionmanager/makeovpnfilefromcustom.cpp
    engine/customconfigs/parseovpnconfigline.cpp
    engine/customconfigs/customovpnauthcredentialsstorage.cpp
    engine/ping/pinghost_tcp.cpp
    engine/ping/pinghost.cpp
    engine/customconfigs/customconfigsdirwatcher.cpp
    engine/wireguardconfig/wireguardconfig.cpp
    engine/wireguardconfig/getwireguardconfig.cpp
    engine/wireguardconfig/getwireguardconfiginloop.cpp
    engine/getdeviceid.cpp
    engineserver.cpp
    clientconnectiondescr.cpp
    engine/connectionmanager/finishactiveconnections.cpp
    engine/networkaccessmanager/certmanager.cpp
    engine/networkaccessmanager/curlinitcontroller.cpp
    engine/networkaccessmanager/curlnetworkmanager2.cpp
    engine/networkaccessmanager/curlreply.cpp
    engine/networkaccessmanager/networkrequest.cpp
    engine/networkaccessmanager/dnscache2.cpp
    engine/networkaccessmanager/networkaccessmanager.cpp

    engine/locationsmodel/enginelocationsmodel.h
    engine/apiinfo/checkupdate.h
    engine/locationsmodel/apilocationsmodel.h
    engine/locationsmodel/customconfiglocationsmodel.h
    engine/locationsmodel/locationitem.h
    engine/locationsmodel/pingipscontroller.h
    engine/locationsmodel/pingstorage.h
    engine/locationsmodel/bestlocation.h
    engine/locationsmodel/locationnode.h
    engine/locationsmodel/baselocationinfo.h
    engine/locationsmodel/mutablelocationinfo.h
    engine/locationsmodel/customconfiglocationinfo.h
    engine/locationsmodel/pinglog.h
        engine/locationsmodel/failedpinglogcontroller.h
        engine/locationsmodel/nodeselectionalgorithm.h
        engine/apiinfo/apiinfo.h
        engine/apiinfo/sessionstatus.h
        engine/apiinfo/location.h
        engine/apiinfo/group.h
        engine/apiinfo/node.h
        engine/apiinfo/notification.h
        engine/apiinfo/portmap.h
        engine/apiinfo/staticips.h
        engine/apiinfo/servercredentials.h
        engine/connectionmanager/adaptergatewayinfo.h
        engine/connectionmanager/makeovpnfile.h
        engine/autoupdater/downloadhelper.h
        engine/macaddresscontroller/imacaddresscontroller.h
        engine/networkdetectionmanager/inetworkdetectionmanager.h
        engine/ping/keepalivemanager.h
        engine/packetsizecontroller.h
        engine/enginesettings.h
        engine/connectionmanager/stunnelmanager.h
        engine/tempscripts_mac.h
        engine/logincontroller/logincontroller.h
        engine/logincontroller/getallconfigscontroller.h
        engine/proxy/proxysettings.h
        engine/types/connectionsettings.h
        engine/getmyipcontroller.h
        engine/firewall/uniqueiplist.h
        engine/helper/ihelper.h
        engine/firewall/firewallcontroller.h
        engine/firewall/firewallexceptions.h
        engine/proxy/proxyservercontroller.h
        engine/connectionmanager/testvpntunnel.h
        engine/types/dnsresolutionsettings.h
        engine/connectionmanager/iconnection.h
        engine/connectionmanager/openvpnconnection.h
        engine/connectionmanager/isleepevents.h
        utils/boost_includes.h
        engine/types/types.h
        engine/connectionmanager/connsettingspolicy/baseconnsettingspolicy.h
        engine/connectionmanager/connsettingspolicy/autoconnsettingspolicy.h
        engine/connectionmanager/connsettingspolicy/manualconnsettingspolicy.h
        engine/connectionmanager/connsettingspolicy/customconfigconnsettingspolicy.h
        engine/connectionmanager/connectionmanager.h
        engine/logincontroller/getapiaccessips.h
        engine/helper/initializehelper.h
        engine/refetchservercredentialshelper.h
        engine/connectionmanager/availableport.h
        engine/vpnshare/httpproxyserver/httpproxyserver.h
        engine/vpnshare/httpproxyserver/httpproxyconnectionmanager.h
        engine/vpnshare/httpproxyserver/httpproxyconnection.h
        engine/vpnshare/httpproxyserver/httpproxyrequestparser.h
        engine/vpnshare/httpproxyserver/httpproxyrequest.h
        engine/vpnshare/httpproxyserver/httpproxyheader.h
        engine/vpnshare/httpproxyserver/httpproxywebanswer.h
        engine/vpnshare/httpproxyserver/httpproxywebanswerparser.h
        engine/vpnshare/socksproxyserver/socksproxyserver.h
        engine/vpnshare/socksproxyserver/socksproxyconnectionmanager.h
        engine/vpnshare/socksproxyserver/socksproxyconnection.h
        engine/vpnshare/socksproxyserver/socksstructs.h
        engine/vpnshare/socksproxyserver/socksproxyreadexactly.h
        engine/vpnshare/socksproxyserver/socksproxyidentreqparser.h
        engine/vpnshare/socketutils/socketwriteall.h
        engine/vpnshare/socksproxyserver/socksproxycommandparser.h
        engine/vpnshare/vpnsharecontroller.h
        engine/vpnshare/connecteduserscounter.h
        engine/vpnshare/httpproxyserver/httpproxyreply.h
        engine/connectstatecontroller/iconnectstatecontroller.h
        engine/connectstatecontroller/connectstatecontroller.h
        engine/openvpnversioncontroller.h
        engine/serverapi/curlnetworkmanager.h
        engine/serverapi/curlrequest.h
        engine/serverapi/dnscache.h
        engine/serverapi/serverapi.h
        engine/engine.h
        engine/crossplatformobjectfactory.h
        engine/types/loginsettings.h
        engine/emergencycontroller/emergencycontroller.h
        engine/dnsresolver/areslibraryinit.h
        engine/dnsresolver/dnsutils.h
        engine/dnsresolver/dnsrequest.h
        engine/dnsresolver/dnsserversconfiguration.h
        engine/dnsresolver/dnsresolver.h
        engine/types/protocoltype.h
        engine/tests/sessionandlocations_test.h
        engine/sessionstatustimer.h
        engine/connectionmanager/wstunnelmanager.h
        engine/customconfigs/icustomconfig.h
        engine/customconfigs/customconfigtype.h
        engine/customconfigs/ovpncustomconfig.h
        engine/customconfigs/wireguardcustomconfig.h
        engine/customconfigs/customconfigs.h
        engine/connectionmanager/makeovpnfilefromcustom.h
        engine/customconfigs/parseovpnconfigline.h
        engine/customconfigs/customovpnauthcredentialsstorage.h
        engine/ping/icmp_header.h
        engine/ping/ipv4_header.h
        engine/ping/pinghost_tcp.h
        engine/ping/pinghost.h
        engine/customconfigs/customconfigsdirwatcher.h
        engine/wireguardconfig/wireguardconfig.h
        engine/wireguardconfig/getwireguardconfig.h
        engine/wireguardconfig/getwireguardconfiginloop.h
        engine/getdeviceid.h
        engineserver.h
        clientconnectiondescr.h
        engine/connectionmanager/finishactiveconnections.h
        engine/networkaccessmanager/certmanager.h
        engine/networkaccessmanager/curlinitcontroller.h
        engine/networkaccessmanager/curlnetworkmanager2.h
        engine/networkaccessmanager/curlreply.h
        engine/networkaccessmanager/networkrequest.h
        engine/networkaccessmanager/dnscache2.h
        engine/networkaccessmanager/networkaccessmanager.h
        engine.qrc
)

if (WIN32)
    set(WINDOWS_PROJECT_SOURCES
        engine/connectionmanager/adapterutils_win.cpp
        engine/dnsinfo_win.cpp
        engine/taputils/tapinstall_win.cpp
        engine/helper/helper_win.cpp
        engine/proxy/autodetectproxy_win.cpp
        engine/firewall/firewallcontroller_win.cpp
        utils/bfe_service_win.cpp
        utils/ras_service_win.cpp
        engine/dnsresolver/dnsutils_win.cpp
        engine/adaptermetricscontroller_win.cpp
        engine/connectionmanager/sleepevents_win.cpp
        utils/installedantiviruses_win.cpp
        engine/taputils/checkadapterenable.cpp
        engine/vpnshare/wifisharing/wifisharing.cpp
        engine/vpnshare/wifisharing/icsmanager.cpp
        engine/vpnshare/wifisharing/wlanmanager.cpp
        engine/helper/windscribeinstallhelper_win.cpp
        engine/connectionmanager/ikev2connection_win.cpp
        engine/measurementcpuusage.cpp
        engine/ping/pinghost_icmp_win.cpp
        engine/connectionmanager/ikev2connectiondisconnectlogic_win.cpp
        engine/macaddresscontroller/macaddresscontroller_win.cpp
        engine/networkdetectionmanager/networkdetectionmanager_win.cpp
        engine/networkdetectionmanager/networkchangeworkerthread.cpp
        engine/connectionmanager/wireguardconnection_win.cpp
        engine/connectionmanager/wireguardringlogger.cpp

        engine/connectionmanager/adapterutils_win.h
        engine/dnsinfo_win.h
        engine/taputils/tapinstall_win.h
        engine/helper/helper_win.h
        engine/proxy/autodetectproxy_win.h
        engine/firewall/firewallcontroller_win.h
        utils/bfe_service_win.h
        utils/ras_service_win.h
        engine/adaptermetricscontroller_win.h
        engine/connectionmanager/sleepevents_win.h
        utils/installedantiviruses_win.h
        engine/taputils/checkadapterenable.h
        engine/vpnshare/wifisharing/wifisharing.h
        engine/vpnshare/wifisharing/icsmanager.h
        engine/vpnshare/wifisharing/wlanmanager.h
        engine/helper/windscribeinstallhelper_win.h
        engine/connectionmanager/ikev2connection_win.h
        engine/measurementcpuusage.h
        engine/ping/pinghost_icmp_win.h
        engine/connectionmanager/ikev2connectiondisconnectlogic_win.h
        engine/macaddresscontroller/macaddresscontroller_win.h
        engine/networkdetectionmanager/networkdetectionmanager_win.h
        engine/networkdetectionmanager/networkchangeworkerthread.h
        engine/connectionmanager/wireguardconnection_win.h
        engine/connectionmanager/wireguardringlogger.h
    )
endif (WIN32)


add_library(engine STATIC ${PROJECT_SOURCES} ${WINDOWS_PROJECT_SOURCES})

target_link_libraries(engine PRIVATE Qt${QT_VERSION_MAJOR}::Core Qt${QT_VERSION_MAJOR}::Network Qt${QT_VERSION_MAJOR}::Core5Compat)
target_compile_definitions(engine PRIVATE CMAKE_LIBRARY_LIBRARY
                                  WINVER=0x0601
                                  _WIN32_WINNT=0x0601
                                  WIN32_LEAN_AND_MEAN
                                  PIO_APC_ROUTINE_DEFINED)


target_include_directories(engine PRIVATE
    ${CMAKE_CURRENT_SOURCE_DIR}/../../common
    ${CMAKE_CURRENT_SOURCE_DIR}/../../build-libs/protobuf/release/include
    ${CMAKE_CURRENT_SOURCE_DIR}/../../build-libs/boost/include
    ${CMAKE_CURRENT_SOURCE_DIR}/../../build-libs/curl/include
    ${CMAKE_CURRENT_SOURCE_DIR}/../../build-libs/cares/dll_x64/include
    ${CMAKE_CURRENT_SOURCE_DIR}/../../build-libs/openssl/include
)

